I"K°<h1 id="snp-calling">SNP calling</h1>

<p>Here we run the SNP and dosage calling using <a href="http://bio-bwa.sourceforge.net/bwa.shtml">BWA</a> and <a href="https://gatk.broadinstitute.org/hc/en-us">GATK</a> just for a subset of a tetraploid rose GBS data set. This subset contains only four individuals and sequences that aligned to the half of <em>Rosa chinensis</em> chromosome 4. Check the RAM and CPU that was used to run the same pipeline for the full data set below:</p>

<p><img src="log10_efficiency_rose.png" alt="Computational resources required to run this pipeline in the rose complete data (mean depth ~83 and population size of 114 progeny)" /></p>

<h2 id="what-you-will-need-to-run-this-tutorial">What you will need to run this tutorial</h2>

<ul>
  <li>Linux system (or WSL)</li>
  <li>At least 4G RAM</li>
  <li>At least 7G HD</li>
  <li>Docker or singularity</li>
  <li>Internet connection</li>
</ul>

<p><strong>warning</strong>: Before start, it is important to highlight that all software here presented have several parameters that can be adjusted for each given scenario. Here, we will use the default settings, but for the best usage of each one of them, it is important to explore their specificity. So‚Ä¶ use it carefully with other data sets!</p>

<h1 id="getting-all-required-software">Getting all required software</h1>

<p>To save time during the tutorial, pull now all the required images:</p>

<ul>
  <li>Docker</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull biocontainers/fastqc:v0.11.9_cv7
docker pull ewels/multiqc:latest
docker pull kfdrc/bwa-picard:latest-dev
docker pull cristaniguti/r-samtools:latest
docker pull kfdrc/cutadapt:latest
docker pull taniguti/gatk-picard:latest
docker pull us.gcr.io/broad-gotc-prod/genomes-in-the-cloud:2.5.7-2021-06-09_16-47-48Z
docker pull cristaniguti/reads2map:0.0.3
</code></pre></div></div>

<ul>
  <li>Singularity</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> .singularity
<span class="nb">cd</span> .singularity

<span class="nb">export </span><span class="nv">SINGULARITY_CACHEDIR</span><span class="o">=</span><span class="nv">$SCRATCH</span>/.singularity

singularity pull biocontainers_fastqc_v0.11.9_cv7.sif docker://biocontainers/fastqc:v0.11.9_cv7
singularity pull ewels_multiqc.sif docker://ewels/multiqc:latest
singularity pull kfdrc_bwa-picard_latest-dev.sif docker://kfdrc/bwa-picard:latest-dev
singularity pull cristaniguti_r-samtools_latest.sif docker://cristaniguti/r-samtools:latest
singularity pull kfdrc_cutadapt_latest.sif docker://kfdrc/cutadapt:latest
singularity pull taniguti_gatk-picard_latest.sif docker://taniguti/gatk-picard:latest
singularity pull us.gcr.io_broad-gotc-prod_genomes-in-the-cloud:2.5.7-2021-06-09_16-47-48Z.sif docker://us.gcr.io/broad-gotc-prod/genomes-in-the-cloud:2.5.7-2021-06-09_16-47-48Z
singularity pull cristaniguti_reads2map_0.0.3.sif docker://cristaniguti/reads2map:0.0.3
</code></pre></div></div>

<p>Run this command and go take a coffee, it can take some time. If you are using Docker, don‚Äôt forget to remove all images and containers after you finish your analysis to avoid occupy space in the computer.</p>

<h1 id="getting-the-example-data-set">Getting the example data set</h1>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>Tools2023
<span class="nb">cd </span>Tools2023

wget https://github.com/Cristianetaniguti/Reads2Map/raw/develop/tests/data/polyploid/fastq/1.fastq.gz
wget https://github.com/Cristianetaniguti/Reads2Map/raw/develop/tests/data/polyploid/fastq/98.fastq.gz
wget https://github.com/Cristianetaniguti/Reads2Map/raw/develop/tests/data/polyploid/fastq/P1.fastq.gz
wget https://github.com/Cristianetaniguti/Reads2Map/raw/develop/tests/data/polyploid/fastq/P2.fastq.gz

wget https://github.com/Cristianetaniguti/Reads2Map/raw/develop/tests/data/polyploid/RchinensisV1.0/Chr04_sub.fasta
</code></pre></div></div>

<h1 id="quality-control">Quality Control</h1>

<p>A classic way to have a overview of our FASTQ sequences is the FASTQC software:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for </span>i <span class="k">in</span> <span class="k">*</span>.fastq.gz<span class="p">;</span> <span class="k">do</span> <span class="c"># Will run in all files in the directory finishing with fastq</span>
    <span class="nb">echo</span> <span class="nv">$i</span>
    docker run <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>:/opt biocontainers/fastqc:v0.11.9_cv7 fastqc /opt/<span class="nv">$i</span>
<span class="k">done</span>
</code></pre></div></div>

<p>or</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for </span>i <span class="k">in</span> <span class="k">*</span>.fastq.gz<span class="p">;</span> <span class="k">do</span> <span class="c"># Will run in all files in the directory finishing with fastq</span>
    <span class="nb">echo</span> <span class="nv">$i</span>
    singularity <span class="nb">exec</span> <span class="nt">--bind</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>:/opt <span class="nv">$SCRATCH</span>/.singularity/biocontainers_fastqc_v0.11.9_cv7.sif fastqc /opt/<span class="nv">$i</span>
<span class="k">done</span>
</code></pre></div></div>

<p>See <a href="https://cristianetaniguti.github.io/tools2023/1_fastqc.html">here</a> the result for sample 1.</p>

<p>It returns to us an HTML file with several precious pieces of information. 
Instead of checking separated HTML by sample, we can join them using the very fancy MULTIQC tool.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-t</span> <span class="nt">-v</span> <span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>:<span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span> <span class="nt">-w</span> <span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span> ewels/multiqc <span class="nb">.</span>  <span class="nt">--title</span> <span class="s2">"Tutorial samples"</span>
</code></pre></div></div>

<p>or</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>singularity run <span class="nv">$SCRATCH</span>/.singularity/ewels_multiqc.sif <span class="nb">.</span> <span class="nt">--title</span> <span class="s2">"Tutorial samples"</span>
</code></pre></div></div>

<p>Results <a href="https://cristianetaniguti.github.io/tools2023/Tutorial-samples_multiqc_report.html">here</a>.</p>

<p>This profile is typical from GBS sequences, other types of libraries would return other profiles and could have different problems.</p>

<p>Now, that we already checked how our sequences are, we can decide which filters to use to clean them. Here, the samples are already filtered and demultiplexed, but if it is not, process_radtags from STACKs perform the demultiplexing and some other quality filters, as searching for the enzyme cut site and according to sequence Phred scale. Check its manual <a href="https://catchenlab.life.illinois.edu/stacks/comp/process_radtags.php">here</a>.</p>

<h1 id="alignment">Alignment</h1>

<p>There are many software to perform the alignment. The suggested by GATK team is the BWA-MEM.</p>

<p>BWA requires some index files before the alignment, you can build them with:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>:/opt/ kfdrc/bwa-picard:latest-dev bwa index /opt/Chr04_sub.fasta

docker run <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>:/opt/ kfdrc/bwa-picard:latest-dev  java <span class="nt">-jar</span> /picard.jar CreateSequenceDictionary <span class="se">\</span>
    <span class="nv">R</span><span class="o">=</span>/opt/Chr04_sub.fasta <span class="se">\</span>
    <span class="nv">O</span><span class="o">=</span>/opt/Chr04_sub.dict
</code></pre></div></div>

<p>or</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>singularity run <span class="nt">--bind</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>:/opt/ <span class="nv">$SCRATCH</span>/.singularity/kfdrc_bwa-picard_latest-dev.sif bwa index /opt/Chr04_sub.fasta

singularity run <span class="nt">--bind</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>:/opt/ <span class="nv">$SCRATCH</span>/.singularity/kfdrc_bwa-picard_latest-dev.sif  java <span class="nt">-jar</span> /picard.jar  CreateSequenceDictionary <span class="se">\</span>
    <span class="nv">R</span><span class="o">=</span>/opt/Chr04_sub.fasta <span class="se">\</span>
    <span class="nv">O</span><span class="o">=</span>/opt/Chr04_sub.dict
</code></pre></div></div>

<p>Run BWA-MEM for each sample file:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for </span>i <span class="k">in</span> <span class="k">*</span>.fastq.gz<span class="p">;</span> <span class="k">do
  </span><span class="nb">echo</span> <span class="nv">$i</span>
  <span class="nv">filename</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">i</span><span class="p">%%.*</span><span class="k">}</span><span class="s2">"</span>
  <span class="nb">echo</span> <span class="nv">$filename</span>
  <span class="c">#Alignment</span>
  docker run <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>:/opt/ kfdrc/bwa-picard:latest-dev bwa mem <span class="nt">-t</span> 2 <span class="se">\</span>
    <span class="nt">-R</span> <span class="s2">"@RG</span><span class="se">\t</span><span class="s2">ID:</span><span class="nv">$filename</span><span class="se">\t</span><span class="s2">LB:lib1</span><span class="se">\t</span><span class="s2">PL:illumina</span><span class="se">\t</span><span class="s2">SM:</span><span class="nv">$filename</span><span class="se">\t</span><span class="s2">PU:FLOWCELL1.LANE1"</span> <span class="se">\</span>
    /opt/Chr04_sub.fasta /opt/<span class="nv">$i</span> <span class="o">&gt;</span> <span class="nv">$filename</span>.bam

  <span class="c">#Sort BAM File</span>
  docker run <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>:/opt kfdrc/bwa-picard:latest-dev java <span class="nt">-jar</span> /picard.jar SortSam <span class="se">\</span>
    <span class="nv">I</span><span class="o">=</span><span class="s2">"/opt/</span><span class="nv">$filename</span><span class="s2">.bam"</span> <span class="se">\</span>
    <span class="nv">O</span><span class="o">=</span><span class="s2">"/opt/</span><span class="nv">$filename</span><span class="s2">.sorted.bam"</span> <span class="se">\</span>
    <span class="nv">TMP_DIR</span><span class="o">=</span>./tmp <span class="se">\</span>
    <span class="nv">SORT_ORDER</span><span class="o">=</span>coordinate <span class="se">\</span>
    <span class="nv">CREATE_INDEX</span><span class="o">=</span><span class="nb">true
</span><span class="k">done</span>
</code></pre></div></div>

<p>or</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for </span>i <span class="k">in</span> <span class="k">*</span>fastq.gz<span class="p">;</span> <span class="k">do
  </span><span class="nb">echo</span> <span class="nv">$i</span>
  <span class="nv">filename</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">i</span><span class="p">%%.*</span><span class="k">}</span><span class="s2">"</span>
  <span class="nb">echo</span> <span class="nv">$filename</span>
  <span class="c">#Alignment</span>
  singularity run <span class="nt">--bind</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>:/opt/ <span class="nv">$SCRATCH</span>/.singularity/kfdrc_bwa-picard_latest-dev.sif bwa mem <span class="nt">-t</span> 2 <span class="se">\</span>
    <span class="nt">-R</span> <span class="s2">"@RG</span><span class="se">\t</span><span class="s2">ID:</span><span class="nv">$filename</span><span class="se">\t</span><span class="s2">LB:lib1</span><span class="se">\t</span><span class="s2">PL:illumina</span><span class="se">\t</span><span class="s2">SM:</span><span class="nv">$filename</span><span class="se">\t</span><span class="s2">PU:FLOWCELL1.LANE1"</span> <span class="se">\</span>
    /opt/Chr04_sub.fasta /opt/<span class="nv">$i</span> <span class="o">&gt;</span> <span class="nv">$filename</span>.bam
    
  <span class="c">#Sort BAM File</span>
  singularity run <span class="nt">--bind</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>:/opt <span class="nv">$SCRATCH</span>/.singularity/kfdrc_bwa-picard_latest-dev.sif java <span class="nt">-jar</span> /picard.jar SortSam <span class="se">\</span>
    <span class="nv">I</span><span class="o">=</span><span class="s2">"/opt/</span><span class="nv">$filename</span><span class="s2">.bam"</span> <span class="se">\</span>
    <span class="nv">O</span><span class="o">=</span><span class="s2">"/opt/</span><span class="nv">$filename</span><span class="s2">.sorted.bam"</span> <span class="se">\</span>
    <span class="nv">TMP_DIR</span><span class="o">=</span>./tmp <span class="se">\</span>
    <span class="nv">SORT_ORDER</span><span class="o">=</span>coordinate <span class="se">\</span>
    <span class="nv">CREATE_INDEX</span><span class="o">=</span><span class="nb">true
</span><span class="k">done</span>
</code></pre></div></div>

<p>If you have more than one genome and want to test how much your sample aligns with each one, <a href="https://www.bioinformatics.babraham.ac.uk/projects/fastq_screen/">FASTQ screen</a> is a good tool for that.</p>

<h1 id="gatk---joint-call">GATK - Joint Call</h1>

<p>GATK is a toolkit with more than 200 available tools. You can imagine a practical guide is not a place to explain all its features. Anyway, the Broad Institute team made really good work with tutorials on their <a href="https://gatk.broadinstitute.org/hc/en-us">website</a>. GATK also has workflows available <a href="https://gatk.broadinstitute.org/hc/en-us/sections/360007226651-Best-Practices-Workflows">here</a> for the most common scenarios. The bad news is that these scenarios did not evolve RADseq or GBS data sets. GATK workflows need adaptations to analyze these data sets. A good example is the duplicates, you can‚Äôt remove GBS duplicates and for WGS or exome, this is an important step. If you have lots of previous information about your species, as a good reference genome or a marker database, this information can be used to increase SNP and genotype calling in GATK with tools such as BQSR and Variant recalibrator. If you don‚Äôt have much previous information, GATK provides several quality measures for each marker called and you can apply what they call ‚Äúhard filters‚Äù in your markers.</p>

<p>The called Joint Call makes the variant calling by sample and produces the g.vcf files, a VCF which have records for every position in the genome. After a database is created to join this information and we can extract it to the traditional VCF file. The analysis is done separately for several reasons, one is flexibility of processing, we can parallelize the way we want. Another is the called N+1 problem, which means that with the database created, you don‚Äôt need to repeat all the analysis if you want to add an extra sample.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># It requires other indexes</span>
docker run <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>:/opt/ cristaniguti/r-samtools:latest samtools faidx /opt/Chr04_sub.fasta

<span class="k">for </span>i <span class="k">in</span> <span class="k">*</span>sorted.bam<span class="p">;</span> <span class="k">do
  </span><span class="nv">filename</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">i</span><span class="p">%%.*</span><span class="k">}</span><span class="s2">"</span>
  <span class="nb">echo</span> <span class="nv">$filename</span>
  docker run <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>:/opt taniguti/gatk-picard:latest /gatk/gatk HaplotypeCaller <span class="se">\</span>
                                                    <span class="nt">-ERC</span> GVCF <span class="se">\</span>
                                                    <span class="nt">-R</span> /opt/Chr04_sub.fasta <span class="se">\</span>
                                                    <span class="nt">-ploidy</span> 4 <span class="se">\</span>
                                                    <span class="nt">-I</span> /opt/<span class="nv">$i</span> <span class="se">\</span>
                                                    <span class="nt">-O</span> /opt/<span class="nv">$filename</span>.g.vcf <span class="se">\</span>
                                                    <span class="nt">--max-reads-per-alignment-start</span> 0
<span class="k">done

</span>zcat Chr04_sub.fasta | <span class="nb">grep</span> <span class="s2">"&gt;"</span>  <span class="o">&gt;</span> interval_list_temp <span class="c"># Find scaffold name</span>
<span class="nb">sed</span> <span class="s1">'s/^.//'</span> interval_list_temp <span class="o">&gt;</span> interval_list_temp2 <span class="c"># remove &gt; at the beginning</span>
<span class="nb">awk</span>  <span class="s1">'{print $1;}'</span> interval_list_temp2 <span class="o">&gt;</span> interval.list <span class="c"># gets only the first word</span>

docker run <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>:/opt taniguti/gatk-picard:latest /gatk/gatk GenomicsDBImport <span class="se">\</span>
                                                  <span class="nt">--genomicsdb-workspace-path</span> /opt/my_database <span class="se">\</span>
                                                  <span class="nt">-L</span> /opt/interval.list <span class="se">\</span>
                                                  <span class="nt">-V</span> /opt/1.g.vcf <span class="se">\</span>
                                                  <span class="nt">-V</span> /opt/98.g.vcf <span class="se">\</span>
                                                  <span class="nt">-V</span> /opt/P1.g.vcf <span class="se">\</span>
                                                  <span class="nt">-V</span> /opt/P2.g.vcf 

docker run <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>:/opt taniguti/gatk-picard:latest /gatk/gatk GenotypeGVCFs <span class="se">\</span>
                                                   <span class="nt">-R</span> /opt/Chr04_sub.fasta<span class="se">\</span>
                                                   <span class="nt">-O</span> /opt/gatk.vcf.gz <span class="se">\</span>
                                                   <span class="nt">-G</span> StandardAnnotation <span class="se">\</span>
                                                   <span class="nt">-V</span> gendb:///opt/my_database
                                                   
</code></pre></div></div>

<p>or</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># It requires other indexes</span>
singularity <span class="nb">exec</span> <span class="nt">--bind</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>:/opt/ <span class="nv">$SCRATCH</span>/.singularity/cristaniguti_r-samtools_latest.sif samtools faidx /opt/Chr04_sub.fasta

<span class="k">for </span>i <span class="k">in</span> <span class="k">*</span>sorted.bam<span class="p">;</span> <span class="k">do
  </span><span class="nv">filename</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">i</span><span class="p">%%.*</span><span class="k">}</span><span class="s2">"</span>
  <span class="nb">echo</span> <span class="nv">$filename</span>
  singularity <span class="nb">exec</span> <span class="nt">--bind</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>:/opt <span class="nv">$SCRATCH</span>/.singularity/taniguti_gatk-picard_latest.sif /gatk/gatk HaplotypeCaller <span class="se">\</span>
                                                    <span class="nt">-ERC</span> GVCF <span class="se">\</span>
                                                    <span class="nt">-R</span> /opt/Chr04_sub.fasta<span class="se">\</span>
                                                    <span class="nt">-ploidy</span> 4 <span class="se">\</span>
                                                    <span class="nt">-I</span> /opt/<span class="nv">$i</span> <span class="se">\</span>
                                                    <span class="nt">-O</span> /opt/<span class="nv">$filename</span>.g.vcf <span class="se">\</span>
                                                    <span class="nt">--max-reads-per-alignment-start</span> 0
<span class="k">done

</span><span class="nb">grep</span> <span class="s2">"&gt;"</span> Chr04_sub.fasta <span class="o">&gt;</span> interval_list_temp <span class="c"># Find scaffold name</span>
<span class="nb">sed</span> <span class="s1">'s/^.//'</span> interval_list_temp <span class="o">&gt;</span> interval_list_temp2 <span class="c"># remove &gt; at the beginning</span>
<span class="nb">awk</span>  <span class="s1">'{print $1;}'</span> interval_list_temp2 <span class="o">&gt;</span> interval.list <span class="c"># gets only the first word</span>

singularity <span class="nb">exec</span> <span class="nt">--bind</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>:/opt <span class="nv">$SCRATCH</span>/.singularity/taniguti_gatk-picard_latest.sif /gatk/gatk GenomicsDBImport <span class="se">\</span>
                                                  <span class="nt">--genomicsdb-workspace-path</span> /opt/my_database <span class="se">\</span>
                                                  <span class="nt">-L</span> /opt/interval.list <span class="se">\</span>
                                                  <span class="nt">-V</span> /opt/1.g.vcf <span class="se">\</span>
                                                  <span class="nt">-V</span> /opt/98.g.vcf <span class="se">\</span>
                                                  <span class="nt">-V</span> /opt/P1.g.vcf <span class="se">\</span>
                                                  <span class="nt">-V</span> /opt/P2.g.vcf 

singularity <span class="nb">exec</span> <span class="nt">--bind</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>:/opt <span class="nv">$SCRATCH</span>/.singularity/taniguti_gatk-picard_latest.sif /gatk/gatk GenotypeGVCFs <span class="se">\</span>
                                                   <span class="nt">-R</span> /opt/Chr04_sub.fasta <span class="se">\</span>
                                                   <span class="nt">-O</span> /opt/gatk.vcf.gz <span class="se">\</span>
                                                   <span class="nt">-G</span> StandardAnnotation <span class="se">\</span>
                                                   <span class="nt">-V</span> gendb:///opt/my_database
                                                   
</code></pre></div></div>

<p>gatk.vcf.gz:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#CHROM  POS     ID      REF     ALT     QUAL    FILTER  INFO    FORMAT  1       98      P1      P2
Chr04   21571   .       G       T       3156.21 .       AC=12;AF=1.00;AN=12;DP=76;FS=0.000;MLEAC=13;MLEAF=1.00;MQ=60.00;QD=25.36;SOR=8.688      GT:AD:DP:GQ:PL  1/1/1/1:0,3:3:4:125,18,9,4,0    1/1/1/1:0,7:7:9:292,42,21,9,0   1/1/1/1:0,66:66:82:2724,396,198,82,0    ./././.:0,0:0:.:0,0,0,0,0
Chr04   68559   .       C       T       55.28   .       AC=1;AF=0.083;AN=12;BaseQRankSum=0.705;DP=104;FS=0.000;MLEAC=1;MLEAF=0.083;MQ=60.00;MQRankSum=0.00;QD=1.35;ReadPosRankSum=-5.340e-01;SOR=0.010  GT:AD:DP:GQ:PL  ./././.:0,0:0:.:0,0,0,0,0       0/0/0/1:38,3:41:58:60,0,58,167,1576     0/0/0/0:1,0:1:1:0,1,3,6,42      0/0/0/0:62,0:62:50:0,50,120,241,1800
Chr04   68581   .       C       T       818.57  .       AC=3;AF=0.250;AN=12;BaseQRankSum=-2.420e+00;DP=100;FS=0.000;MLEAC=4;MLEAF=0.333;MQ=60.00;MQRankSum=0.00;QD=8.27;ReadPosRankSum=1.80;SOR=0.211   GT:AD:DP:GQ:PL  ./././.:0,0:0:.:0,0,0,0,0       0/0/1/1:15,26:41:1:732,48,0,1,515       0/0/0/0:1,0:1:1:0,1,3,6,42      0/0/0/1:52,6:58:75:88,0,75,221,2055
Chr04   68593   .       C       T       47.28   .       AC=1;AF=0.083;AN=12;BaseQRankSum=-1.709e+00;DP=100;FS=0.000;MLEAC=1;MLEAF=0.083;MQ=60.00;MQRankSum=0.00;QD=0.82;ReadPosRankSum=3.02;SOR=0.008   GT:AD:DP:GQ:PL  ./././.:0,0:0:.:0,0,0,0,0       0/0/0/0:41,0:41:50:0,50,120,241,1800    0/0/0/0:1,0:1:1:0,1,3,6,30      0/0/0/1:54,4:58:52:52,0,83,239,2285
Chr04   68612   .       C       T       1512.17 .       AC=3;AF=0.250;AN=12;BaseQRankSum=0.775;DP=100;FS=0.000;MLEAC=4;MLEAF=0.333;MQ=60.00;MQRankSum=0.00;QD=15.27;ReadPosRankSum=7.39;SOR=0.358       GT:AD:DP:GQ:PL  ./././.:0,0:0:.:0,0,0,0,0       0/0/0/1:38,3:41:58:69,0,58,167,1644     0/0/0/0:1,0:1:1:0,1,3,6,30      0/0/1/1:22,36:58:3:1445,70,0,3,815
Chr04   68619   .       C       T       1512.17 .       AC=3;AF=0.250;AN=12;BaseQRankSum=0.554;DP=100;FS=0.000;MLEAC=4;MLEAF=0.333;MQ=60.00;MQRankSum=0.00;QD=15.27;ReadPosRankSum=7.39;SOR=0.358       GT:AD:DP:GQ:PL  ./././.:0,0:0:.:0,0,0,0,0       0/0/0/1:38,3:41:58:69,0,58,167,1644     0/0/0/0:1,0:1:1:0,1,3,6,30      0/0/1/1:22,36:58:3:1445,70,0,3,815
</code></pre></div></div>

<h1 id="reads2map-workflows">Reads2Map workflows</h1>

<p><a href="https://github.com/Cristianetaniguti/Reads2Map">Reads2Map</a> is a collection of WDL workflows to build linkage maps from sequencing data. It was first developed to diploids (<a href="https://www.biorxiv.org/content/10.1101/2022.11.24.517847v2">preprint</a>) and is being expanded to polyploids. The sub-workflow EmpiricalSNPCalling.wdl is already adapted to polyploids. It performs:</p>

<ul>
  <li>Alignment with BWA (parallelize the samples in cores and nodes)</li>
  <li>SNP calling with GATK (parallelize the samples in cores and nodes)</li>
  <li><a href="https://gatk.broadinstitute.org/hc/en-us/articles/360035890471-Hard-filtering-germline-short-variants">GATK hard filtering</a></li>
  <li>SNP calling with freebayes (parallelize the genomic regions in cores and nodes)</li>
</ul>

<p>What we will need:</p>

<ul>
  <li><a href="https://github.com/Cristianetaniguti/Reads2Map/releases/tag/EmpiricalSNPCalling_develop">EmpiricalSNPCalling workflow - Reads2Map</a></li>
  <li><a href="https://github.com/Cristianetaniguti/Reads2Map/tree/main/.configurations">Configuration files</a></li>
  <li><a href="https://github.com/broadinstitute/cromwell/releases">Download cromwell</a></li>
  <li>Java</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://github.com/Cristianetaniguti/Reads2Map/releases/download/EmpiricalSNPCalling_develop/EmpiricalSNPCalling_develop.wdl
wget https://github.com/Cristianetaniguti/Reads2Map/releases/download/EmpiricalSNPCalling_develop/EmpiricalSNPCalling_develop.zip
wget https://github.com/Cristianetaniguti/Reads2Map/raw/develop/.configurations/cromwell_no_mysql.conf
</code></pre></div></div>

<p>Prepare input file <code class="language-plaintext highlighter-rouge">EmpiricalSNPCalling_develop.json</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "SNPCalling.max_cores": 2,
  "SNPCalling.ploidy": 4,
  "SNPCalling.rm_dupli": false,
  "SNPCalling.run_gatk": true,
  "SNPCalling.run_freebayes": true,
  "SNPCalling.hardfilters": true,
  "SNPCalling.n_chrom": 1,
  "SNPCalling.chunk_size": 2,
  "SNPCalling.samples_info": "samples_info.txt",
  "SNPCalling.references": {
    "ref_fasta": "Chr04_sub.fasta",
    "ref_dict": "Chr04_sub.dict",
    "ref_ann": "Chr04_sub.fasta.ann",
    "ref_sa": "Chr04_sub.fasta.sa",
    "ref_amb": "Chr04_sub.fasta.amb",
    "ref_pac": "Chr04_sub.fasta.pac",
    "ref_bwt": "Chr04_sub.fasta.bwt",
    "ref_fasta_index": "Chr04_sub.fasta.fai"
  }
}
</code></pre></div></div>

<p>samples_info.txt:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1.fastq.gz   1   1
98.fastq.gz   98    98
P1.fastq.gz   P1    P1
P2.fastq.gz   P2    P2
</code></pre></div></div>

<p>Set the default in <code class="language-plaintext highlighter-rouge">cromwell_no_mysql.conf</code> to <code class="language-plaintext highlighter-rouge">SlurmSingularity</code>.</p>

<p>Run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">SINGULARITY_CACHEDIR</span><span class="o">=</span><span class="nv">$SCRATCH</span>/.singularity

java <span class="nt">-jar</span> <span class="nt">-Dconfig</span>.file<span class="o">=</span>cromwell_no_mysql.conf <span class="nt">-jar</span> cromwell.jar run EmpiricalSNPCalling_develop.wdl <span class="se">\</span>
                      <span class="nt">-i</span> EmpiricalSNPCalling_develop.json <span class="se">\</span>
                      <span class="nt">-p</span> EmpiricalSNPCalling_develop.zip
</code></pre></div></div>

<h2 id="dosage-calling">Dosage calling</h2>

<p>Install the R packages:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">install.packages</span><span class="p">(</span><span class="s2">"polyRAD"</span><span class="p">)</span><span class="w">
</span><span class="n">install.packages</span><span class="p">(</span><span class="s2">"updog"</span><span class="p">)</span><span class="w">
</span><span class="n">install.packages</span><span class="p">(</span><span class="s2">"fitPoly"</span><span class="p">)</span><span class="w"> 

</span><span class="n">install.packages</span><span class="p">(</span><span class="s2">"vcfR"</span><span class="p">)</span><span class="w"> </span><span class="c1"># To manipulate VCF file inside R</span><span class="w">
</span></code></pre></div></div>

<p>Check their documentation:</p>

<ul>
  <li><a href="https://github.com/lvclark/polyRAD">polyRAD</a></li>
  <li><a href="https://dcgerard.github.io/updog/">updog</a></li>
</ul>

<p>Check this tutorial if you have array data:</p>

<p>*<a href="https://www.polyploids.org/sites/default/files/2021-01/SCRI_fitPoly_workshop.html">Dosage scoring / fitPoly workshop</a></p>

<p>Example considering a $F_1$ outcrossing population:</p>

<h3 id="example-with-updog">Example with updog</h3>

<p>Get the example data. It is the same data set as before, but now with 122 samples and a subset of chromosome 10.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://github.com/Cristianetaniguti/Reads2Map/raw/develop/tests/data/polyploid/vcf_poly_filt.vcf.gz
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">vcfR</span><span class="p">)</span><span class="w">

</span><span class="n">vcf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.vcfR</span><span class="p">(</span><span class="s2">"vcf_poly_filt.vcf.gz"</span><span class="p">)</span><span class="w">
</span><span class="n">vcf</span><span class="w">

</span><span class="n">sizemat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">extract.gt</span><span class="p">(</span><span class="n">vcf</span><span class="p">,</span><span class="w"> </span><span class="s2">"DP"</span><span class="p">)</span><span class="w">

</span><span class="n">ADmat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">extract.gt</span><span class="p">(</span><span class="n">vcf</span><span class="p">,</span><span class="w"> </span><span class="s2">"AD"</span><span class="p">)</span><span class="w">
</span><span class="n">refmat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">strsplit</span><span class="p">(</span><span class="n">ADmat</span><span class="p">,</span><span class="w"> </span><span class="s2">","</span><span class="p">)</span><span class="w">
</span><span class="n">refmat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sapply</span><span class="p">(</span><span class="n">refmat</span><span class="p">,</span><span class="w"> </span><span class="s2">"[["</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
</span><span class="n">refmat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="n">refmat</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">ADmat</span><span class="p">))</span><span class="w">
</span><span class="n">refmat</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">]</span><span class="w">
</span><span class="n">ADmat</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">,</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">]</span><span class="w">

</span><span class="n">library</span><span class="p">(</span><span class="n">updog</span><span class="p">)</span><span class="w">

</span><span class="n">mout</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">multidog</span><span class="p">(</span><span class="n">refmat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">refmat</span><span class="p">,</span><span class="w"> 
                 </span><span class="n">sizemat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sizemat</span><span class="p">,</span><span class="w"> 
                 </span><span class="n">ploidy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> 
                 </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"f1"</span><span class="p">,</span><span class="w">
                 </span><span class="n">nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">

</span><span class="n">sizemat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">apply</span><span class="p">(</span><span class="n">sizemat</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">as.numeric</span><span class="p">)</span><span class="w">
</span><span class="n">refmat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">apply</span><span class="p">(</span><span class="n">refmat</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">as.numeric</span><span class="p">)</span><span class="w">

</span><span class="n">mout</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">multidog</span><span class="p">(</span><span class="n">refmat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">refmat</span><span class="p">,</span><span class="w"> 
                 </span><span class="n">sizemat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sizemat</span><span class="p">,</span><span class="w"> 
                 </span><span class="n">ploidy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> 
                 </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"f1"</span><span class="p">,</span><span class="w">
                 </span><span class="n">nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">

</span><span class="n">colnames</span><span class="p">(</span><span class="n">refmat</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colnames</span><span class="p">(</span><span class="n">sizemat</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colnames</span><span class="p">(</span><span class="n">ADmat</span><span class="p">)</span><span class="w">
</span><span class="n">rownames</span><span class="p">(</span><span class="n">refmat</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rownames</span><span class="p">(</span><span class="n">sizemat</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rownames</span><span class="p">(</span><span class="n">ADmat</span><span class="p">)</span><span class="w">

</span><span class="n">mout</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">multidog</span><span class="p">(</span><span class="n">refmat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">refmat</span><span class="p">,</span><span class="w"> 
                 </span><span class="n">sizemat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sizemat</span><span class="p">,</span><span class="w"> 
                 </span><span class="n">ploidy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> 
                 </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"f1"</span><span class="p">,</span><span class="w">
                 </span><span class="n">nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">

</span><span class="n">plot</span><span class="p">(</span><span class="n">mout</span><span class="p">,</span><span class="w"> </span><span class="n">indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">))</span><span class="w">

</span><span class="n">genomat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">format_multidog</span><span class="p">(</span><span class="n">mout</span><span class="p">,</span><span class="w"> </span><span class="n">varname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"geno"</span><span class="p">)</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">genomat</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

:ET